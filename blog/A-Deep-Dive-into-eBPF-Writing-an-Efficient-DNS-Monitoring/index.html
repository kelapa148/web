<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.6126b490cf8bdb19a42e.css" id="gatsby-global-css">body,html{margin:0;padding:0}*{margin-top:0}body.light{--primary-color:#381696;--primary-text-color:#fff;--featured-bg:#493b8a;--secondary-color:#10072b;--background:#fff;--card-bg:#fff;--card-bdr:#eee;--card-shadow:#d5d5d5;--contact-bg:#f7f8fe;--contact-bdr:#d3d6e7;--input-bg:var(--background)}body.dark,body.light{--featured-text:#fff;--site-header:var(--background);--btn-bg:var(--background);--btn-bdr:#d3d6e7;--btn-text-color:#868892;--btn-hover-bg:var(--btn-bdr);--btn-hover-text-color:#00062b}body.dark{--primary-color:#9984d5;--primary-text-color:#fff;--featured-bg:#66578d;--secondary-color:#66578d;--background:#0a041a;--text-color:hsla(0,0%,100%,0.88);--text-secondary-color:hsla(0,0%,100%,0.66);--card-bg:#181326;--card-bdr:#181326;--card-shadow:#020204;--contact-bg:var(--card-shadow);--contact-bdr:var(--card-bg);--input-bg:var(--card-bg)}body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif;border-top:10px solid var(--primary-color);background-color:var(--background);color:var(--text-color)}a{color:var(--primary-color);text-decoration:none}a:hover{text-decoration:underline}.site-wrapper{padding:32px;max-width:1140px;margin:0 auto}.site-wrapper img{max-width:100%}.navigation{display:flex;align-items:center;font-weight:300;overflow-x:auto;-ms-overflow-style:none;scrollbar-width:none}.navigation a{color:#888;text-decoration:none;margin:0 8px}.navigation a[aria-current]{color:var(--primary-color);font-weight:700}.navigation a:hover{color:var(--primary-color)}.navigation a:last-child{margin-right:0}.navigation::-webkit-scrollbar{display:none}.site-header{display:flex;justify-content:space-between;padding:20px 0;background:var(--site-header);margin-bottom:32px;align-items:center}.site-title a{margin-right:32px;color:var(--primary-color);text-decoration:none;font-weight:900;text-transform:uppercase}.hero-header{max-width:980px}.headline{font-size:36px;font-weight:900;margin-bottom:.5rem}.button{padding:18px 27px;display:inline-block;background:var(--btn-bg);border:1px solid var(--btn-bdr);border-radius:9px;text-decoration:none;color:var(--btn-text-color);font-size:16px;font-weight:400;margin:0 20px 0 0;transition:background-color .3s linear}.button.-primary{background-color:var(--primary-color);border-color:var(--primary-color);color:var(--primary-text-color)}.button.-primary:hover{background-color:var(--secondary-color);color:var(--primary-text-color);text-decoration:none}.button:hover{background-color:var(--btn-hover-bg);color:var(--btn-hover-text-color)}.primary-content{font-size:18px;margin-bottom:32px;line-height:1.5;font-weight:300}.post{padding:0;background:var(--background);color:var(--text-color);line-height:1.5}.post>.blog-post-content{max-width:768px;margin:0 auto}.post>.blog-post-content :last-child,.post>:last-child{margin-bottom:0}.post .post-title{text-align:center;margin:0 0 .5rem;line-height:1.3;font-size:2rem}.post .post-meta{margin-bottom:32px;text-align:center}.post-thumbnail{text-align:center;min-height:380px;background-color:var(--featured-bg);background-repeat:no-repeat;background-size:cover;background-position:50%;border-radius:18px;margin-bottom:36px;color:var(--featured-text);display:grid;align-content:center;position:relative;padding:18px;overflow:hidden}.post-thumbnail:before{content:"";background:rgba(0,0,0,.4);position:absolute;top:0;left:0;width:100%;height:100%;z-index:1}.post-thumbnail>*{position:relative;z-index:2}.post-thumbnail .post-meta{color:hsla(0,0%,100%,.8);margin-bottom:0}.grids{display:grid;grid-template-columns:1fr;grid-gap:32px;margin-top:32px}.grids.small-on-mobile{grid-template-columns:1fr 1fr}.two-grids{display:grid;grid-gap:32px}.two-grids.-contact .post-thumbnail{min-height:240px!important}.card{display:grid;background-color:var(--card-bg);border-radius:9px;border:1px solid var(--card-bdr);box-shadow:0 0 30px var(--card-shadow);overflow:hidden;line-height:1.5}.card:hover .post-link{color:var(--primary-color)}.card>a img{display:block}.card>header{padding:24px}.card>h2:first-child{margin:0 0 .5rem}.card .post-title{font-size:1.2rem;margin-bottom:.3rem}.card .post-meta{font-weight:100;margin-bottom:0}.card .post-link{color:var(--text-color);text-decoration:none}.post-meta{font-size:.8rem;color:var(--text-secondary-color)}.site-footer{text-align:center;margin:90px 0 16px;color:#666}.site-footer a{font-weight:700}.form-container{background-color:var(--contact-bg);padding:32px;border:1px solid var(--contact-bdr);border-radius:9px}.form-container label{display:block;margin-bottom:.5rem;color:var(--text-secondary-color)}.form-container input[type=email],.form-container input[type=text],.form-container textarea{-webkit-appearance:none;appearance:none;border:1px solid var(--card-shadow);color:var(--text-secondary-color);border-radius:6px;line-height:32px;padding:6px 12px;width:calc(100% - 24px);margin-bottom:1.5rem;background-color:var(--input-bg);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif}.form-container textarea{margin-bottom:2rem;height:150px}@media only screen and (min-width:768px){.grids{grid-template-columns:1fr 1fr}.grids.small{grid-template-columns:1fr 1fr 1fr}}@media only screen and (min-width:1024px){.grids{grid-template-columns:1fr 1fr 1fr}.grids.small{grid-template-columns:1fr 1fr 1fr 1fr}.two-grids{display:grid;grid-template-columns:1fr 1fr;grid-gap:64px}}.theme-changer,body.dark .gg-moon,body.light .gg-sun{display:none}.mode-container{width:24px;height:24px;margin-left:20px}.gg-sun{position:relative;-webkit-transform:scale(var(--ggs,1));transform:scale(var(--ggs,1));height:24px;background:linear-gradient(180deg,currentColor 4px,transparent 0) no-repeat 5px -6px/2px 6px,linear-gradient(180deg,currentColor 4px,transparent 0) no-repeat 5px 14px/2px 6px,linear-gradient(180deg,currentColor 4px,transparent 0) no-repeat -8px 5px/6px 2px,linear-gradient(180deg,currentColor 4px,transparent 0) no-repeat 14px 5px/6px 2px;border-radius:100px;box-shadow:inset 0 0 0 2px;border:6px solid transparent}.gg-sun,.gg-sun:after,.gg-sun:before{box-sizing:border-box;display:block;width:24px}.gg-sun:after,.gg-sun:before{content:"";position:absolute;height:2px;border-right:4px solid;border-left:4px solid;left:-6px;top:5px}.gg-sun:before{-webkit-transform:rotate(-45deg);transform:rotate(-45deg)}.gg-sun:after{-webkit-transform:rotate(45deg);transform:rotate(45deg)}.gg-moon,.gg-moon:after{display:block;box-sizing:border-box;border-radius:50%}.gg-moon{overflow:hidden;position:relative;-webkit-transform:rotate(-135deg) scale(var(--ggs,1));transform:rotate(-135deg) scale(var(--ggs,1));width:20px;height:20px;border:2px solid;border-bottom:2px solid transparent}.gg-moon:after{content:"";position:absolute;width:12px;height:18px;border:2px solid transparent;box-shadow:0 0 0 2px;top:8px;left:2px}.embed-container{height:0;margin-bottom:18px;overflow:hidden;padding-bottom:20%;padding-top:30px;position:relative}.embed-container embed,.embed-container iframe,.embed-container object{height:100%!important;left:0;position:absolute;top:0;width:100%!important}.outer-container{margin-bottom:64px}.image-container{display:flex;justify-content:center;align-items:center}.image-container .embed-container{height:0;margin-bottom:18px;overflow:hidden;padding-bottom:20%;padding-top:30px;position:relative}.image-container .embed-container embed,.image-container .embed-container iframe,.image-container .embed-container object{height:100%!important;left:0;position:absolute;top:0;width:100%!important}.image-container img{max-width:100%;width:400px}.image-container.funder{padding:8px;margin-bottom:0}.avatar-container{display:flex;flex-direction:column;justify-content:center;align-items:center}.avatar-container img{margin-bottom:1em}.avatar-container .people-meta{font-size:14.8px}.people-avatar{-o-object-fit:cover;object-fit:cover;aspect-ratio:1}.people-avatar.details{width:12rem;height:12rem;border-radius:9999px}.publication-item{margin-bottom:16px}.publication-item h2{font-size:16px;margin:0 0 4px}.publication-item .publication-meta{font-size:12.8px}body.light{--main-color:#000;--main-text-shadow:#fff;--main-bg:#f5f2f0;--token-comment:#708090;--token-prolog:#708090;--token-doctype:#708090;--token-cdata:#708090;--token-punctuation:#999;--token-property:#905;--token-tag:#905;--token-boolean:#905;--token-number:#905;--token-constant:#905;--token-symbol:#905;--token-deleted:#905;--token-selector:#690;--token-attr-name:#690;--token-string:#690;--token-char:#690;--token-builtin:#690;--token-inserted:#690;--token-operator:#9a6e3a;--token-entity:#9a6e3a;--token-url:#9a6e3a;--token-atrule:#07a;--token-attr-value:#07a;--token-keyword:#07a;--token-function:#dd4a68;--token-class-name:#dd4a68;--token-regex:#e90;--token-important:#e90;--token-variable:#e90}body.dark{--main-color:#ccc;--main-text-shadow:transparent;--main-bg:#2d2d2d;--token-comment:#999;--token-block-comment:#999;--token-prolog:#999;--token-doctype:#999;--token-cdata:#999;--token-punctuation:#ccc;--token-tag:#e2777a;--token-attr-name:#e2777a;--token-namespace:#e2777a;--token-deleted:#e2777a;--token-function-name:#6196cc;--token-boolean:#f08d49;--token-number:#f08d49;--token-function:#f08d49;--token-property:#f8c555;--token-class-name:#f8c555;--token-constant:#f8c555;--token-symbol:#f8c555;--token-selector:#cc99cd;--token-important:#cc99cd;--token-atrule:#cc99cd;--token-keyword:#cc99cd;--token-builtin:#cc99cd;--token-string:#7ec699;--token-char:#7ec699;--token-attr-value:#7ec699;--token-regex:#7ec699;--token-variable:#7ec699;--token-operator:#67cdcc;--token-entity:#67cdcc;--token-url:#67cdcc;--token-inserted:green}code[class*=language-],pre[class*=language-]{color:var(--main-color);background:none;text-shadow:0 1px var(--main-text-shadow);font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:var(--main-bg)}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.comment{color:var(--token-comment)}.token.prolog{color:var(--token-prolog)}.token.doctype{color:var(--token-doctype)}.token.cdata{color:var(--token-cdata)}.token.punctuation{color:var(--token-punctuation)}.token.namespace{color:var(--token-namespace);opacity:.7}.token.property{color:var(--token-property)}.token.tag{color:var(--token-tag)}.token.boolean{color:var(--token-boolean)}.token.number{color:var(--token-number)}.token.constant{color:var(--token-constant)}.token.symbol{color:var(--token-symbol)}.token.deleted{color:var(--token-deleted)}.token.selector{color:var(--token-selector)}.token.attr-name{color:var(--token-attr-name)}.token.string{color:var(--token-string)}.token.char{color:var(--token-char)}.token.builtin{color:var(--token-builtin)}.token.inserted{color:var(--token-inserted)}.token.operator{color:var(--token-operator)}.token.entity{color:var(--token-entity)}.token.url{color:var(--token-url)}.language-css .token.string,.style .token.string{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule{color:var(--token-atrule)}.token.attr-value{color:var(--token-attr-value)}.token.keyword{color:var(--token-keyword)}.token.function{color:var(--token-function)}.token.class-name{color:var(--token-class-name)}.token.regex{color:var(--token-regex)}.token.important{color:var(--token-important)}.token.variable{color:var(--token-variable)}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.block-comment{color:var(--token-block-comment)}.token.function-name{color:var(--token-function-name)}:not(pre)>code[class*=language-]{padding:.15em .35em}pre[class*=language-]{margin-bottom:16px!important}</style><meta name="generator" content="Gatsby 2.32.13"/><link rel="preconnect" href="https://www.google-analytics.com"/><link rel="dns-prefetch" href="https://www.google-analytics.com"/><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-164743872-1', 'auto', {});
      
      
      
      
      
      }</script><link rel="icon" href="/favicon-32x32.png?v=a78a535a767ed5283a7ebe3b70f1b6f2" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><meta name="theme-color" content="#381696"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=a78a535a767ed5283a7ebe3b70f1b6f2"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=a78a535a767ed5283a7ebe3b70f1b6f2"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=a78a535a767ed5283a7ebe3b70f1b6f2"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=a78a535a767ed5283a7ebe3b70f1b6f2"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=a78a535a767ed5283a7ebe3b70f1b6f2"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=a78a535a767ed5283a7ebe3b70f1b6f2"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=a78a535a767ed5283a7ebe3b70f1b6f2"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=a78a535a767ed5283a7ebe3b70f1b6f2"/><title data-react-helmet="true">A Deep Dive into eBPF: Writing an Efficient DNS Monitoring | #COCONUT</title><meta data-react-helmet="true" property="og:url" content="https://coconut.or.id/blog/A-Deep-Dive-into-eBPF-Writing-an-Efficient-DNS-Monitoring"/><meta data-react-helmet="true" property="og:type" content="article"/><meta data-react-helmet="true" property="og:title" content="A Deep Dive into eBPF: Writing an Efficient DNS Monitoring | #COCONUT"/><meta data-react-helmet="true" property="og:description" content="A Deep Dive into eBPF - Writing an Efficient DNS Monitoring"/><meta data-react-helmet="true" property="og:image" content="https://coconut.or.id/assets/blogs/ebpf_nurkholish_halim.png"/><meta data-react-helmet="true" property="og:locale" content="en_US"/><meta data-react-helmet="true" property="og:site_name" content="A Deep Dive into eBPF: Writing an Efficient DNS Monitoring | #COCONUT"/><meta data-react-helmet="true" property="twitter:title" content="A Deep Dive into eBPF: Writing an Efficient DNS Monitoring | #COCONUT"/><meta data-react-helmet="true" property="twitter:card" content="summary_large_image"/><meta data-react-helmet="true" property="twitter:image" content="https://coconut.or.id/assets/blogs/ebpf_nurkholish_halim.png"/><meta data-react-helmet="true" property="twitter:description" content="A Deep Dive into eBPF - Writing an Efficient DNS Monitoring"/><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link as="script" rel="preload" href="/webpack-runtime-d26e86d850dfdeba7fbd.js"/><link as="script" rel="preload" href="/framework-31413af41550353e296a.js"/><link as="script" rel="preload" href="/styles-84a9bc99193fe5828ffe.js"/><link as="script" rel="preload" href="/532a2f07-cee85b289ce281e20d67.js"/><link as="script" rel="preload" href="/app-673a4e1fe8d7056214a0.js"/><link as="script" rel="preload" href="/6b858033f0c41a2341f97b0990d9e7b8428feed3-09e633e911b47e485fbe.js"/><link as="script" rel="preload" href="/component---src-templates-blog-template-js-ae206132cc4c9aa40802.js"/><link as="fetch" rel="preload" href="/page-data/blog/A-Deep-Dive-into-eBPF-Writing-an-Efficient-DNS-Monitoring/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/3159585216.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/440143384.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><script>
void function() {
  window.__onThemeChange = function() {}

  var preferredTheme
  try {
    preferredTheme = localStorage.getItem('theme')
  } catch (err) { }

  function setTheme(newTheme) {
    if (preferredTheme && document.body.classList.contains(preferredTheme)) {
      document.body.classList.replace(preferredTheme, newTheme)
    } else {
      document.body.classList.add(newTheme)
    }

    window.__theme = newTheme
    preferredTheme = newTheme
    window.__onThemeChange(newTheme)
  }

  window.__setPreferredTheme = function(newTheme) {
    setTheme(newTheme)
    try {
      localStorage.setItem('theme', newTheme)
    } catch (err) {}
  }

  var darkQuery = window.matchMedia('(prefers-color-scheme: dark)')
  darkQuery.addListener(function(e) {
    window.__setPreferredTheme(e.matches ? 'dark' : 'light')
  })

  setTheme(preferredTheme || (darkQuery.matches ? 'dark' : 'light'))
}()
    </script><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="site-wrapper"><header class="site-header"><div class="site-title"><a href="/">#COCONUT</a></div><nav class="navigation"><a href="/people">People</a><a href="/publications">Publications</a><a href="/blog">Blogs</a><a href="/resources">Resources</a><a href="/contact">Contact</a><label><input type="checkbox" class="theme-changer"/> <div class="mode-container"><i class="gg-sun"></i><i class="gg-moon"></i></div></label></nav></header><div class="blog-post-container"><article class="post"><div class="post-thumbnail" style="background-image:url(/assets/blogs/ebpf_nurkholish_halim.png)"><h1 class="post-title">A Deep Dive into eBPF: Writing an Efficient DNS Monitoring</h1><div class="post-meta">August 30, 2022<!-- --> - <!-- -->Nurkholish Halim</div></div><div class="blog-post-content"><p><a href="https://docs.kernel.org/bpf/classic_vs_extended.html">eBPF</a> is an in-kernel virtual machine, provides a high-level library, instruction set and an execution environment inside the Linux kernel. It’s used in many Linux kernel subsystems, most prominently networking, tracing, debugging and security. Including to modify the processing of packets in the kernel and also allows the programming of network devices such as <a href="https://blogs.nvidia.com/blog/2021/10/29/what-is-a-smartnic/">SmartNICs</a>.</p>
<p>I will not talk here the detail about what eBPF is. <a href="https://github.com/zoidbergwill/awesome-ebpf">A lot of posts have already been published about the eBPF</a> and in a variety of languages. Although many of these are fairly informative, they don’t answer the most important questions: How does the eBPF process packets and monitor the packet take from the host to the user?. I will describe the process of creating an actual application from the beginning, especially in monitoring requests, responses and process in DNS, gradually enriching the functionality and accompanying all this with explanations, comments, and links to the source code. And sometimes a little off the side because you want to give a few more examples, not just a solution to a specific problem. As a result, I hope those who want to get acquainted with eBPF will spend less time researching for useful materials and start programming faster.</p>
<h2>Introduction</h2>
<p>Let’s say the host can send legitimate DNS requests, but the IP addresses it will send them are unknown. In the network filter log, you can see that the requests are still coming. But it’s not clear — is this just legitimate, or is the information already leaking to the attackers? It would be easier if the domain to which the server sends data were known. Unfortunately, PTR is out of fashion, and securitytrails show either nothing or too much on this IP.</p>
<p>You can run <em><a href="https://www.tcpdump.org/manpages/tcpdump.1.html">tcpdump</a></em>. But who wants to look at the monitor constantly? And if there is more than one server? There is a <em><a href="https://www.elastic.co/beats/packetbeat">packetbeat</a></em> from ELK Stack and this is a monster that has eaten out the processor on all my servers. Osquery is a good tool that knows much about network connections and not about DNS queries. The relevant offer was closed. <em><a href="https://zeek.org/">Zeek</a></em> — I learned about it while looking for how to track DNS queries. It seems like it’s not bad, but I was confused by two points: it monitors not only DNS, which means resources will be spent on work that I don’t need the result of (although, perhaps, you can select protocols in the settings); and it also doesn’t know anything about which process sent the request.</p>
<p>We will write in Python and start with the simplest — we will understand how Python and eBPF interact. First, we will install these packages:</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment">#apt install python3-bpfcc bpfcc-tools libbpfcc linux-headers-$(uname -r)</span></code></pre></div>
<p>This is for Ubuntu. But if you go into the kernel, finding the necessary packages for your distribution should not be a problem. Now let’s get started:</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span>
<span class="token keyword">from</span> bcc <span class="token keyword">import</span> BPF
FIRST_BPF <span class="token operator">=</span> <span class="token triple-quoted-string string">r"""
int first(void *ctx) {
  bpf_trace_printk("Hello world! execve() is calling\n");
  return 0;
}
"""</span>
bpf <span class="token operator">=</span> BPF<span class="token punctuation">(</span>text<span class="token operator">=</span>FIRST_BPF<span class="token punctuation">)</span>
bpf<span class="token punctuation">.</span>attach_kprobe<span class="token punctuation">(</span>event<span class="token operator">=</span>bpf<span class="token punctuation">.</span>get_syscall_fnname<span class="token punctuation">(</span><span class="token string">"execve"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fn_name<span class="token operator">=</span><span class="token string">"first"</span><span class="token punctuation">)</span>
<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token punctuation">(</span>_<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> event_b<span class="token punctuation">)</span> <span class="token operator">=</span> bpf<span class="token punctuation">.</span>trace_fields<span class="token punctuation">(</span><span class="token punctuation">)</span>
        events <span class="token operator">=</span> event_b<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token string">'Hello world'</span> <span class="token keyword">in</span> events<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>events<span class="token punctuation">)</span>
    <span class="token keyword">except</span> ValueError<span class="token punctuation">:</span>
        <span class="token keyword">continue</span>
    <span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>
        <span class="token keyword">break</span></code></pre></div>
<blockquote>
<p><strong><em>Note</em></strong>: Unprivileged users were allowed to load eBPF programs by default in Ubuntu 20.04 LTS and 18.04 LTS, however, on more recent Ubuntu releases (21.10 and 22.04 LTS) this was disabled by default for security concern. You can re-enable this ability :</p>
</blockquote>
<blockquote>
<p>$ sudo sysctl kernel.unprivileged<em>bpf</em>disabled=0</p>
</blockquote>
<p>As befits all hello-world examples, it doesn’t do anything useful but introduces us to the basics. Every time any program on the host calls the <strong>execve()</strong> system call, the <strong>first()</strong> function of our program gets executed. To trigger it, you can run the command “<strong>ls</strong>|<strong>cat</strong>|<strong>grep</strong>|<strong>clear</strong> or any command containing <strong>execve()</strong>” on a different console, then our code gets executed. eBPF programs can be called on various events occurring in the kernel. <strong>attach_kprobe()</strong> means triggered when a specific kernel function is called. But we are more used to dealing with system calls. Who knows the names of the corresponding functions? Therefore, a helper function converts the system call name to a kernel function <strong>get_syscall_fnname()</strong>.</p>
<p>The simplest output option in eBPF is a function <strong>bpf_trace_printk()</strong>. But this is the output for debugging. Everything you pass to this function will be available via a file <em>/sys/kernel/debug/tracing/trace_pipe</em>. And to not read this file in the next console, we use a function trace_fields() that reads this file itself and makes its contents available to us in the program.</p>
<p>The rest of it should be clear — in an infinite loop interrupted by Ctrl-C, we read the debug output, and if “Hello world” occurs in the string, we output it in its entirety.</p>
<blockquote>
<p><strong><em>Note</em></strong>: <strong>bpf_trace_printk()</strong> can format text, similar <em>printf()</em>, but with important restrictions — no more than 3 arguments and only one of them %s.</p>
</blockquote>
<p>Now that we understand how to work with eBPF in general let’s start building an actual application. It will monitor all DNS requests and responses and log who asked what and what response they received.</p>
<h2>The Beginning</h2>
<p>Let’s start with eBPF. The easiest way to work with packets is to attach them to a network socket. In this case, our program will be triggered for each packet. I’ll show you exactly how this is done later, but for now, we need to catch UDP with port 53 among all the packets. And to do this, we will have to disassemble the package structure ourselves and separate all the nested protocols in C. Starting with Ethernet. A macro that cursor_advance moves the cursor (pointer) around the packet, returning its current position and shifting it by the specified amount, will help us do this:</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/if_ether.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/in.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;bcc/proto.h></span></span>
<span class="token keyword">int</span> <span class="token function">dns_matching</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">__sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    u8 <span class="token operator">*</span>cursor <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token comment">// Checking the IP protocol::</span>
    <span class="token keyword">struct</span> <span class="token class-name">ethernet_t</span> <span class="token operator">*</span>ethernet <span class="token operator">=</span> <span class="token function">cursor_advance</span><span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>ethernet<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ethernet<span class="token operator">-></span>type <span class="token operator">==</span> ETH_P_IP<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        …</code></pre></div>
<p> The structure <strong>ethernet_t</strong> described in the <a href="https://github.com/iovisor/bcc/blob/master/src/cc/export/proto.h#L25">proto.h</a> file:</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">ethernet_t</span> <span class="token punctuation">{</span>
 <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span>  dst<span class="token operator">:</span><span class="token number">48</span><span class="token punctuation">;</span>
 <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span>  src<span class="token operator">:</span><span class="token number">48</span><span class="token punctuation">;</span>
 <span class="token keyword">unsigned</span> <span class="token keyword">int</span>        type<span class="token operator">:</span><span class="token number">16</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> BPF_PACKET_HEADER<span class="token punctuation">;</span></code></pre></div>
<p> The Ethernet frame format itself is pretty simple — it’s 6 bytes (48 bits) of the destination, the same number of sources, and then two bytes (16 bits) of the content type.</p>
<p>The content type is encoded by a constant <strong>ETH<em>P</em>IP</strong> equal to <em>0x0800</em> and defined in the file if_ether.h — it allows you to ensure that the next-level protocol is IP (this code, as well as other possible values, is described by the IEEE).</p>
<p>Let’s move on and check if the IP is nested in UDP with port 53:</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token comment">// Checking the UDP protocol:</span>
<span class="token keyword">struct</span> <span class="token class-name">ip_t</span> <span class="token operator">*</span>ip <span class="token operator">=</span> <span class="token function">cursor_advance</span><span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>ip<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>ip<span class="token operator">-></span>nextp <span class="token operator">==</span> IPPROTO_UDP<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Checking port 53:</span>
    <span class="token keyword">struct</span> <span class="token class-name">udp_t</span> <span class="token operator">*</span>udp <span class="token operator">=</span> <span class="token function">cursor_advance</span><span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>udp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>udp<span class="token operator">-></span>dport <span class="token operator">==</span> <span class="token number">53</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Request</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>udp<span class="token operator">-></span>sport <span class="token operator">==</span> <span class="token number">53</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Respose</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p><strong>ip_t</strong> and <strong>udp_t</strong> they’re still the same <a href="https://github.com/iovisor/bcc/blob/master/src/cc/export/proto.h#L25">proto.h</a>. But <strong>IPPROTO_UDP</strong> is already from the file <a href="https://github.com/torvalds/linux/blob/master/include/uapi/linux/in.h#L43">in.h</a>. In general, this example is not entirely correct. The IP structure is already a little more complicated — it has an optional field, which is why the header length may vary. It would be correct to first get the value of its length from the header and only perform the offset, but we have just started — we will not immediately complicate it.</p>
<p>We found the DNS package, and it was not difficult. Now we need to analyse its structure. To make this easier, we will pass the package to user space (it’s responsible for return -1 for this — the return code 0 would mean that the package does not need to be copied).</p>
<p>Back to Python. First, we will still attach our program to the socket:</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span>
<span class="token keyword">import</span> dnslib
<span class="token keyword">import</span> sys
<span class="token keyword">from</span> bcc <span class="token keyword">import</span> BPF
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
bpf <span class="token operator">=</span> BPF<span class="token punctuation">(</span>text<span class="token operator">=</span>BPF_PROGRAM<span class="token punctuation">)</span>
function_dns_matching <span class="token operator">=</span> bpf<span class="token punctuation">.</span>load_func<span class="token punctuation">(</span><span class="token string">"dns_matching"</span><span class="token punctuation">,</span> BPF<span class="token punctuation">.</span>SOCKET_FILTER<span class="token punctuation">)</span>
BPF<span class="token punctuation">.</span>attach_raw_socket<span class="token punctuation">(</span>function_dns_matching<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span></code></pre></div>
<p>This difference from the previous example is because now our program will be called not when calling any function but for each package. An empty argument in <strong>attach_raw_socket</strong> means “all network interfaces,” If we needed a specific one, its name should be there.</p>
<p>Switching the socket to blocking mode:</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> fcntl
<span class="token keyword">import</span> os
socket_fd <span class="token operator">=</span> function_dns_matching<span class="token punctuation">.</span>sock
fl <span class="token operator">=</span> fcntl<span class="token punctuation">.</span>fcntl<span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> fcntl<span class="token punctuation">.</span>F_GETFL<span class="token punctuation">)</span>
fcntl<span class="token punctuation">.</span>fcntl<span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> fcntl<span class="token punctuation">.</span>F_SETFL<span class="token punctuation">,</span> fl <span class="token operator">&amp;</span> <span class="token operator">~</span>os<span class="token punctuation">.</span>O_NONBLOCK<span class="token punctuation">)</span></code></pre></div>
<p>The rest is simple — we use a similar infinite loop, where we read data from the socket, cut off all headers, get directly to the DNS packet and decode it.</p>
<p>Full code here:</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span>

<span class="token keyword">import</span> dnslib
<span class="token keyword">import</span> fcntl
<span class="token keyword">import</span> os
<span class="token keyword">import</span> sys

<span class="token keyword">from</span> bcc <span class="token keyword">import</span> BPF

BPF_APP <span class="token operator">=</span> <span class="token triple-quoted-string string">r'''
#include &lt;linux/if_ether.h>
#include &lt;linux/in.h>
#include &lt;bcc/proto.h>

int dns_matching(struct __sk_buff *skb) {
    u8 *cursor = 0;

     // Checking the IP protocol:
    struct ethernet_t *ethernet = cursor_advance(cursor, sizeof(*ethernet));

    if (ethernet->type == ETH_P_IP) {
         // Checking the UDP protocol:
        struct ip_t *ip = cursor_advance(cursor, sizeof(*ip));

        if (ip->nextp == IPPROTO_UDP) {
             // Check the port 53:
            struct udp_t *udp = cursor_advance(cursor, sizeof(*udp));

            if (udp->dport == 53 || udp->sport == 53) {
                return -1;
            }
        }
    }
    return 0;
}
'''</span>


bpf <span class="token operator">=</span> BPF<span class="token punctuation">(</span>text<span class="token operator">=</span>BPF_APP<span class="token punctuation">)</span>
function_dns_matching <span class="token operator">=</span> bpf<span class="token punctuation">.</span>load_func<span class="token punctuation">(</span><span class="token string">"dns_matching"</span><span class="token punctuation">,</span> BPF<span class="token punctuation">.</span>SOCKET_FILTER<span class="token punctuation">)</span>
BPF<span class="token punctuation">.</span>attach_raw_socket<span class="token punctuation">(</span>function_dns_matching<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>

socket_fd <span class="token operator">=</span> function_dns_matching<span class="token punctuation">.</span>sock
fl <span class="token operator">=</span> fcntl<span class="token punctuation">.</span>fcntl<span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> fcntl<span class="token punctuation">.</span>F_GETFL<span class="token punctuation">)</span>
fcntl<span class="token punctuation">.</span>fcntl<span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> fcntl<span class="token punctuation">.</span>F_SETFL<span class="token punctuation">,</span> fl <span class="token operator">&amp;</span> <span class="token operator">~</span>os<span class="token punctuation">.</span>O_NONBLOCK<span class="token punctuation">)</span>

<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        packet_str <span class="token operator">=</span> os<span class="token punctuation">.</span>read<span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> <span class="token number">2048</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    packet_bytearray <span class="token operator">=</span> <span class="token builtin">bytearray</span><span class="token punctuation">(</span>packet_str<span class="token punctuation">)</span>

    ETH_HLEN <span class="token operator">=</span> <span class="token number">14</span>
    UDP_HLEN <span class="token operator">=</span> <span class="token number">8</span>

    <span class="token comment"># IP header length</span>
    ip_header_length <span class="token operator">=</span> packet_bytearray<span class="token punctuation">[</span>ETH_HLEN<span class="token punctuation">]</span>
    ip_header_length <span class="token operator">=</span> ip_header_length <span class="token operator">&amp;</span> <span class="token number">0x0F</span>
    ip_header_length <span class="token operator">=</span> ip_header_length <span class="token operator">&lt;&lt;</span> <span class="token number">2</span>

    <span class="token comment"># Starting the DNS packet</span>
    payload_offset <span class="token operator">=</span> ETH_HLEN <span class="token operator">+</span> ip_header_length <span class="token operator">+</span> UDP_HLEN

    payload <span class="token operator">=</span> packet_bytearray<span class="token punctuation">[</span>payload_offset<span class="token punctuation">:</span><span class="token punctuation">]</span>

    dnsrec <span class="token operator">=</span> dnslib<span class="token punctuation">.</span>DNSRecord<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

    <span class="token comment"># If it’s the response:</span>
    <span class="token keyword">if</span> dnsrec<span class="token punctuation">.</span>rr<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Resp: </span><span class="token interpolation"><span class="token punctuation">{</span>dnsrec<span class="token punctuation">.</span>rr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rname<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>dnslib<span class="token punctuation">.</span>QTYPE<span class="token punctuation">.</span>get<span class="token punctuation">(</span>dnsrec<span class="token punctuation">.</span>rr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rtype<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token string">", "</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">repr</span><span class="token punctuation">(</span>dnsrec<span class="token punctuation">.</span>rr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>rdata<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>dnsrec<span class="token punctuation">.</span>rr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    <span class="token comment"># If it’s the request:</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Request: </span><span class="token interpolation"><span class="token punctuation">{</span>dnsrec<span class="token punctuation">.</span>questions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>qname<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>dnslib<span class="token punctuation">.</span>QTYPE<span class="token punctuation">.</span>get<span class="token punctuation">(</span>dnsrec<span class="token punctuation">.</span>questions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>qtype<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span></code></pre></div>
<p>This example will show you which DNS requests/responses pass through your network interface, but this way, we won’t know what process works with them. That is, just the information, due to the lack of which I did not choose Zeek.</p>
<h2>From Packet to Process</h2>
<p>To get information about the process in eBPF, the following functions are used — <strong>bpf_get_current_pid_tgid()</strong>, <strong>bpf_get_current_uid_gid()</strong>, <strong>bpf_get_current_comm(char *buf, int size<em>of</em>buf)</strong>. They are available when we bind our program to a call to some kernel function (as in the first example). The UID/GID should be clear. But the first one requires an explanation for those who have not previously encountered such details of the kernel operation. The fact is that what is seen as a PID in the kernel is displayed in user space as the process thread ID. And what the kernel considers thread group ID-in user space is the PID. Similarly, bpf_get_current_comm() returns not the usual process name, which can be seen through ps command, but the thread name.</p>
<p>All right, we’ll get the process data. How do we pass them to the user space? Tables are used for this purpose. They are created as <strong>BPF_PERF_OUTPUT(event)</strong>, passed by the method event.perf<em>submit(ctx, data, data</em>size), and received by polling via <strong>b.perf_buffer_poll()</strong>. After that, as soon as the data is available, the function <strong>callback()</strong> will be called, thus: b[“event”].open<em>perf</em>buffer(callback).</p>
<p>I will describe all of this in detail below, but for now, let’s continue the theory and reflect on this. We can transmit the packet itself as well as the data. But to do this, we must select a variable of a certain length in the structure with the transmitted data. Which one? The quick and incorrect answer is 512 bytes. But it does not consider EDNS, and I would also like to track (correctly!) DNS packets going over TCP. So we would have to allocate a large amount “in reserve”, discard packages that are still larger, and most of the time, we will have more memory allocated than necessary. I wouldn’t say I like this approach. Fortunately, there is another method — perf<em>submit</em>skb(). In addition to data, it also transmits the specified number of bytes of the packet from the buffer. But there is a caveat — the method is only available for network programs eBPF- socket, XDP. I.e., those where we can not get information about the process.</p>
<p>Fortunately, we can use multiple eBPF programs and exchange data between them! And this also happens through tables. They are declared as follows:</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token function">BPF_TABLE_PUBLIC</span><span class="token punctuation">(</span><span class="token string">"hash"</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">,</span> name<span class="token punctuation">,</span> max_elements<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>This is to make it available to other eBPF programs. And to access it, in another program, we write like this:</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token function">BPF_TABLE</span><span class="token punctuation">(</span><span class="token string">"extern"</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">,</span> name<span class="token punctuation">,</span> max_elements<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>So that we don’t lose our packet among the rest-just 5 unique parameters: protocol, source address, source port, destination address, and destination port, so the key will be the following structure:</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">port_key</span> <span class="token punctuation">{</span>
     u8 proto<span class="token punctuation">;</span>
     u32 saddr<span class="token punctuation">;</span>
     u32 daddr<span class="token punctuation">;</span>
     u16 sport<span class="token punctuation">;</span>
     u16 dport<span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>And the value is everything we want to know about the process:</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">port_val</span> <span class="token punctuation">{</span>
     u32 ifindex<span class="token punctuation">;</span>
     u32 pid<span class="token punctuation">;</span>
     u32 tgid<span class="token punctuation">;</span>
     u32 uid<span class="token punctuation">;</span>
     u32 gid<span class="token punctuation">;</span>
     <span class="token keyword">char</span> comm<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p><em>ifindex</em> — this is a network device. We will fill in this value in another program running on the socket. And here, we use it to transfer the entire structure to the user’s space in the future.</p>
<p>Total: when calling the kernel function to send a packet, we store information about which process is involved. And when a packet appears on the network interface (and it doesn’t matter whether it’s outgoing or incoming), we check whether we have any information for packets traveling between these destinations using such and such a protocol. If it exists, we pass it along with the package to Python, where we do the rest of the work.</p>
<p>Well, the basic logic of the future program was talked through — let’s already program!</p>
<h2>My Name Is Process</h2>
<p>Let’s start by getting information about the process. The <strong>udp_sendmsg()</strong> and <strong>tcp_sendmsg()</strong> functions are used to send packets. Both take the sock structure that we need as the first argument. There are two ways to access the arguments of the function under investigation in eBPF: specify them as parameters of our function, or use the macro <strong>PT_REGS_PARMx</strong>, where x is the argument number. I’ll show you both of these options below. And here is our first program, C<em>BPF</em>KPROBE:</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token comment">// The structure that will be used as the key for </span>
<span class="token comment">// eBPF table 'proc_ports':</span>
<span class="token keyword">struct</span> <span class="token class-name">port_key</span> <span class="token punctuation">{</span>
    u8 proto<span class="token punctuation">;</span>
    u32 saddr<span class="token punctuation">;</span>
    u32 daddr<span class="token punctuation">;</span>
    u16 sport<span class="token punctuation">;</span>
    u16 dport<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// The structure that will be stored in the eBPF table 'proc_ports' </span>
<span class="token comment">// contains information about the process:</span>
<span class="token keyword">struct</span> <span class="token class-name">port_val</span> <span class="token punctuation">{</span>
    u32 ifindex<span class="token punctuation">;</span>
    u32 pid<span class="token punctuation">;</span>
    u32 tgid<span class="token punctuation">;</span>
    u32 uid<span class="token punctuation">;</span>
    u32 gid<span class="token punctuation">;</span>
    <span class="token keyword">char</span> comm<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// Public (accessible from other eBPF programs) eBPF table in which </span>
<span class="token comment">// information about the process is written. </span>
<span class="token comment">// It's read when a packet appears on the socket:</span>
<span class="token function">BPF_TABLE_PUBLIC</span><span class="token punctuation">(</span><span class="token string">"hash"</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">port_key</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">port_val</span><span class="token punctuation">,</span> proc_ports<span class="token punctuation">,</span> <span class="token number">20480</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// These are two ways to get access to the function arguments:</span>
<span class="token comment">//int trace_udp_sendmsg(struct pt_regs *ctx) {</span>
<span class="token comment">// struct sock *sk = (struct sock *)PT_REGS_PARM1(ctx);</span>
<span class="token keyword">int</span> <span class="token function">trace_udp_sendmsg</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pt_regs</span> <span class="token operator">*</span>ctx<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sock</span> <span class="token operator">*</span>sk<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    u16 sport <span class="token operator">=</span> sk<span class="token operator">-></span>sk_num<span class="token punctuation">;</span>
    u16 dport <span class="token operator">=</span> sk<span class="token operator">-></span>sk_dport<span class="token punctuation">;</span>
  
    <span class="token comment">// Processing packets only on port 53.</span>
    <span class="token comment">// 13568 = ntohs(53);</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sport <span class="token operator">==</span> <span class="token number">13568</span> <span class="token operator">||</span> dport <span class="token operator">==</span> <span class="token number">13568</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Preparing the data:</span>
        u32 saddr <span class="token operator">=</span> sk<span class="token operator">-></span>sk_rcv_saddr<span class="token punctuation">;</span>
        u32 daddr <span class="token operator">=</span> sk<span class="token operator">-></span>sk_daddr<span class="token punctuation">;</span>
        u64 pid_tgid <span class="token operator">=</span> <span class="token function">bpf_get_current_pid_tgid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        u64 uid_gid <span class="token operator">=</span> <span class="token function">bpf_get_current_uid_gid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Forming the key structure.</span>
        <span class="token comment">// These strange transformations will be explained below.</span>
        <span class="token keyword">struct</span> <span class="token class-name">port_key</span> key <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">.</span>proto <span class="token operator">=</span> <span class="token number">17</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        key<span class="token punctuation">.</span>saddr <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span>saddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        key<span class="token punctuation">.</span>daddr <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span>daddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        key<span class="token punctuation">.</span>sport <span class="token operator">=</span> sport<span class="token punctuation">;</span>
        key<span class="token punctuation">.</span>dport <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>dport<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Forming a structure with the process properties:</span>
        <span class="token keyword">struct</span> <span class="token class-name">port_val</span> val <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        val<span class="token punctuation">.</span>pid <span class="token operator">=</span> pid_tgid <span class="token operator">>></span> <span class="token number">32</span><span class="token punctuation">;</span>
        val<span class="token punctuation">.</span>tgid <span class="token operator">=</span> <span class="token punctuation">(</span>u32<span class="token punctuation">)</span>pid_tgid<span class="token punctuation">;</span>
        val<span class="token punctuation">.</span>uid <span class="token operator">=</span> <span class="token punctuation">(</span>u32<span class="token punctuation">)</span>uid_gid<span class="token punctuation">;</span>
        val<span class="token punctuation">.</span>gid <span class="token operator">=</span> uid_gid <span class="token operator">>></span> <span class="token number">32</span><span class="token punctuation">;</span>
        <span class="token function">bpf_get_current_comm</span><span class="token punctuation">(</span>val<span class="token punctuation">.</span>comm<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//Writing the value into the eBPF table:</span>
        proc_ports<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>key<span class="token punctuation">,</span> <span class="token operator">&amp;</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Working with <em>tcp_sendmsg</em> will be absolutely the same. The only difference is that in the structure port_key, the field proto will be equal 6. These two values (17 and 6) are the codes of the UDP and TCP protocols, respectively. You can view these values in the file <em>/etc/protocols</em>.</p>
<p>Both functions bpf_get_current_*return 64 bits, so we take the lower and upper 32 bits separately to extract data. Moreover, for PID/TGID, we immediately take them in the usual form (i.e.pid, we write the upper 32 bits in the field, which contain what the kernel considers to be the TGID).</p>
<p>Now let’s talk about transformations when forming the key structure. We will create a similar structure in the program in the next section. But we will take data, not from the nuclear structure sock but eBPF’s __sk_buff, and in it, the data is stored in this form:</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c">__u32 remote_ip4<span class="token punctuation">;</span> <span class="token comment">/* Stored in network byte order */</span>
__u32 local_ip4<span class="token punctuation">;</span> <span class="token comment">/* Stored in network byte order */</span>
__u32 remote_port<span class="token punctuation">;</span> <span class="token comment">/* Stored in network byte order */</span>
__u32 local_port<span class="token punctuation">;</span> <span class="token comment">/* stored in host byte order */</span></code></pre></div>
<h2>Extracted to User Space</h2>
<p>Our second program <strong>BPF_SOCK_TEXT</strong>, which will “hang” on the socket, will check for information about the corresponding process for each packet and transmit it, along with the packet itself, to user space:</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token comment">// The structure that will be used as the key for</span>
<span class="token comment">// eBPF table 'proc_ports':</span>
<span class="token keyword">struct</span> <span class="token class-name">port_key</span> <span class="token punctuation">{</span>
    u8 proto<span class="token punctuation">;</span>
    u32 saddr<span class="token punctuation">;</span>
    u32 daddr<span class="token punctuation">;</span>
    u16 sport<span class="token punctuation">;</span>
    u16 dport<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// The structure that will be stored in the eBPF table 'proc_ports',</span>
<span class="token comment">// Contains information about the process:</span>
<span class="token keyword">struct</span> <span class="token class-name">port_val</span> <span class="token punctuation">{</span>
    u32 ifindex<span class="token punctuation">;</span>
    u32 pid<span class="token punctuation">;</span>
    u32 tgid<span class="token punctuation">;</span>
    u32 uid<span class="token punctuation">;</span>
    u32 gid<span class="token punctuation">;</span>
    <span class="token keyword">char</span> comm<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// eBPF table from which information about the process is extracted.</span>
<span class="token comment">// Filled when calling kernel functions udp_sendmsg()/tcp_sendmsg():</span>
<span class="token function">BPF_TABLE</span><span class="token punctuation">(</span><span class="token string">"extern"</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">port_key</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">port_val</span><span class="token punctuation">,</span> proc_ports<span class="token punctuation">,</span> <span class="token number">20480</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Table for transferring data to the user space:</span>
<span class="token function">BPF_PERF_OUTPUT</span><span class="token punctuation">(</span>dns_events<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Look for DNS packets among the data passing through the socket and </span>
<span class="token comment">// check if there is any information about the process:</span>
<span class="token keyword">int</span> <span class="token function">dns_matching</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">__sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    u8 <span class="token operator">*</span>cursor <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">// Checking the IP protocol:</span>
    <span class="token keyword">struct</span> <span class="token class-name">ethernet_t</span> <span class="token operator">*</span>ethernet <span class="token operator">=</span> <span class="token function">cursor_advance</span><span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>ethernet<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>ethernet<span class="token operator">-></span>type <span class="token operator">==</span> ETH_P_IP<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">ip_t</span> <span class="token operator">*</span>ip <span class="token operator">=</span> <span class="token function">cursor_advance</span><span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>ip<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
u8 proto<span class="token punctuation">;</span>
        u16 sport<span class="token punctuation">;</span>
        u16 dport<span class="token punctuation">;</span>
<span class="token comment">// Checking the transport layer protocol:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ip<span class="token operator">-></span>nextp <span class="token operator">==</span> IPPROTO_UDP<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">struct</span> <span class="token class-name">udp_t</span> <span class="token operator">*</span>udp <span class="token operator">=</span> <span class="token function">cursor_advance</span><span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>udp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            proto <span class="token operator">=</span> <span class="token number">17</span><span class="token punctuation">;</span>
            <span class="token comment">// Getting the data about the ports:</span>
            sport <span class="token operator">=</span> udp<span class="token operator">-></span>sport<span class="token punctuation">;</span>
            dport <span class="token operator">=</span> udp<span class="token operator">-></span>dport<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ip<span class="token operator">-></span>nextp <span class="token operator">==</span> IPPROTO_TCP<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">struct</span> <span class="token class-name">tcp_t</span> <span class="token operator">*</span>tcp <span class="token operator">=</span> <span class="token function">cursor_advance</span><span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>tcp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// We don't need packets where no data is transmitted:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tcp<span class="token operator">-></span>flag_psh<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         proto <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
         <span class="token comment">// Getting the data about the ports:</span>
         sport <span class="token operator">=</span> tcp<span class="token operator">-></span>src_port<span class="token punctuation">;</span>
         dport <span class="token operator">=</span> tcp<span class="token operator">-></span>dst_port<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// If it's a DNS query:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dport <span class="token operator">==</span> <span class="token number">53</span> <span class="token operator">||</span> sport <span class="token operator">==</span> <span class="token number">53</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Form a key structure:</span>
            <span class="token keyword">struct</span> <span class="token class-name">port_key</span> key <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            key<span class="token punctuation">.</span>proto <span class="token operator">=</span> proto<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>skb<span class="token operator">-></span>ingress_ifindex <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                key<span class="token punctuation">.</span>saddr <span class="token operator">=</span> ip<span class="token operator">-></span>src<span class="token punctuation">;</span>
                key<span class="token punctuation">.</span>daddr <span class="token operator">=</span> ip<span class="token operator">-></span>dst<span class="token punctuation">;</span>
                key<span class="token punctuation">.</span>sport <span class="token operator">=</span> sport<span class="token punctuation">;</span>
                key<span class="token punctuation">.</span>dport <span class="token operator">=</span> dport<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                key<span class="token punctuation">.</span>saddr <span class="token operator">=</span> ip<span class="token operator">-></span>dst<span class="token punctuation">;</span>
                key<span class="token punctuation">.</span>daddr <span class="token operator">=</span> ip<span class="token operator">-></span>src<span class="token punctuation">;</span>
                key<span class="token punctuation">.</span>sport <span class="token operator">=</span> dport<span class="token punctuation">;</span>
                key<span class="token punctuation">.</span>dport <span class="token operator">=</span> sport<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// By the key, look for a value in the eBPF table:</span>
            <span class="token keyword">struct</span> <span class="token class-name">port_val</span> <span class="token operator">*</span>p_val<span class="token punctuation">;</span>
            p_val <span class="token operator">=</span> proc_ports<span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// If no value is found, then we have no information about the </span>
            <span class="token comment">// process and there is no point in continuing:</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>p_val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// Network device index:</span>
            p_val<span class="token operator">-></span>ifindex <span class="token operator">=</span> skb<span class="token operator">-></span>ifindex<span class="token punctuation">;</span>
            <span class="token comment">// Transmit the structure with the process information along with </span>
            <span class="token comment">// skb->len bytes sent to the socket:</span>
            dns_events<span class="token punctuation">.</span><span class="token function">perf_submit_skb</span><span class="token punctuation">(</span>skb<span class="token punctuation">,</span> skb<span class="token operator">-></span>len<span class="token punctuation">,</span> p_val<span class="token punctuation">,</span>
                                       <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">port_val</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token comment">//dport == 53 || sport == 53</span>
    <span class="token punctuation">}</span> <span class="token comment">//ethernet->type == ETH_P_IP</span>
<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>The program starts in the same way as one of the first examples considered. We move around the packet and collect information from protocols at different levels. The comment that this approach does not consider the actual length of the IP header is still valid. But something new has also been added — for TCP packets, we check the flag — we don’t need packets that don’t carry data (<em>SYN, ACK</em>, etc.).</p>
<p>But then we must restore the key to get data from the table <em>proc_ports</em>. At the same time, we must distinguish the direction of traffic — after all, when we entered data in the table, we meant that we were the source. But for incoming packets, the source will be the remote server. To understand the direction of movement of packets, I used a field <em>ingress_ifindex</em> that is 0 for outgoing traffic.</p>
<h2>Serving</h2>
<p>From Python, we need three things: load our programs into the kernel, get data from them, and process it.</p>
<p>The first two tasks are simple. Moreover, we have already considered both methods of working with eBPF in the first examples:</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token comment"># BPF initialization:</span>
bpf_kprobe <span class="token operator">=</span> BPF<span class="token punctuation">(</span>text<span class="token operator">=</span>C_BPF_KPROBE<span class="token punctuation">)</span>
bpf_sock <span class="token operator">=</span> BPF<span class="token punctuation">(</span>text<span class="token operator">=</span>BPF_SOCK_TEXT<span class="token punctuation">)</span>
<span class="token comment"># Send UDP:</span>
bpf_kprobe<span class="token punctuation">.</span>attach_kprobe<span class="token punctuation">(</span>event<span class="token operator">=</span><span class="token string">"udp_sendmsg"</span><span class="token punctuation">,</span> fn_name<span class="token operator">=</span><span class="token string">"trace_udp_sendmsg"</span><span class="token punctuation">)</span>
<span class="token comment"># Send TCP:</span>
bpf_kprobe<span class="token punctuation">.</span>attach_kprobe<span class="token punctuation">(</span>event<span class="token operator">=</span><span class="token string">"tcp_sendmsg"</span><span class="token punctuation">,</span> fn_name<span class="token operator">=</span><span class="token string">"trace_tcp_sendmsg"</span><span class="token punctuation">)</span>
<span class="token comment"># Socket:</span>
function_dns_matching <span class="token operator">=</span> bpf_sock<span class="token punctuation">.</span>load_func<span class="token punctuation">(</span><span class="token string">"dns_matching"</span><span class="token punctuation">,</span> BPF<span class="token punctuation">.</span>SOCKET_FILTER<span class="token punctuation">)</span>
BPF<span class="token punctuation">.</span>attach_raw_socket<span class="token punctuation">(</span>function_dns_matching<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span></code></pre></div>
<p>Getting data is even shorter:</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">bpf_sock<span class="token punctuation">[</span><span class="token string">"dns_events"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>open_perf_buffer<span class="token punctuation">(</span>print_dns<span class="token punctuation">)</span>
<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        bpf_sock<span class="token punctuation">.</span>perf_buffer_poll<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>
        exit<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></div>
<p>But data processing will be more cumbersome. Despite the availability of ready-made modules, I decided to parse the protocol headers myself. First, I wanted to figure out for myself how this happens (and finally correctly process the length of the IP packet header, although in this case, it’s pointless because packets with additional options in the header will be discarded in eBPF), and secondly — to reduce dependence on modules. However, for parsing DNS directly, I still (so far) use the module-the DNS structure is slightly more complex than IP / TCP. Another module (ctypes) is needed for working with C-sh data types:</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">print_dns</span><span class="token punctuation">(</span>cpu<span class="token punctuation">,</span> data<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">import</span> ctypes <span class="token keyword">as</span> ct
    <span class="token keyword">class</span> <span class="token class-name">SkbEvent</span><span class="token punctuation">(</span>ct<span class="token punctuation">.</span>Structure<span class="token punctuation">)</span><span class="token punctuation">:</span>
        _fields_ <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token punctuation">(</span><span class="token string">"ifindex"</span><span class="token punctuation">,</span> ct<span class="token punctuation">.</span>c_uint32<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token string">"pid"</span><span class="token punctuation">,</span> ct<span class="token punctuation">.</span>c_uint32<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token string">"tgid"</span><span class="token punctuation">,</span> ct<span class="token punctuation">.</span>c_uint32<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token string">"uid"</span><span class="token punctuation">,</span> ct<span class="token punctuation">.</span>c_uint32<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token string">"gid"</span><span class="token punctuation">,</span> ct<span class="token punctuation">.</span>c_uint32<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token string">"comm"</span><span class="token punctuation">,</span> ct<span class="token punctuation">.</span>c_char <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token string">"raw"</span><span class="token punctuation">,</span> ct<span class="token punctuation">.</span>c_ubyte <span class="token operator">*</span> <span class="token punctuation">(</span>size <span class="token operator">-</span> ct<span class="token punctuation">.</span>sizeof<span class="token punctuation">(</span>ct<span class="token punctuation">.</span>c_uint32 <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">-</span> ct<span class="token punctuation">.</span>sizeof<span class="token punctuation">(</span>ct<span class="token punctuation">.</span>c_char <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span>
    <span class="token comment"># We get our 'port_val' structure and also the packet itself in the 'raw' field:</span>
    sk <span class="token operator">=</span> ct<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>data<span class="token punctuation">,</span> ct<span class="token punctuation">.</span>POINTER<span class="token punctuation">(</span>SkbEvent<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>contents
<span class="token comment"># Protocols:</span>
    NET_PROTO <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">6</span><span class="token punctuation">:</span> <span class="token string">"TCP"</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">:</span> <span class="token string">"UDP"</span><span class="token punctuation">}</span>
<span class="token comment"># eBPF operates on thread names.</span>
    <span class="token comment"># Sometimes they coincide with process names, but often not.</span>
    <span class="token comment"># So we try to get the process name by its PID:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'/proc/</span><span class="token interpolation"><span class="token punctuation">{</span>sk<span class="token punctuation">.</span>pid<span class="token punctuation">}</span></span><span class="token string">/comm'</span></span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> proc_comm<span class="token punctuation">:</span>
            proc_name <span class="token operator">=</span> proc_comm<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rstrip<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        proc_name <span class="token operator">=</span> sk<span class="token punctuation">.</span>comm<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># Get the name of the network interface by index:</span>
    ifname <span class="token operator">=</span> if_indextoname<span class="token punctuation">(</span>sk<span class="token punctuation">.</span>ifindex<span class="token punctuation">)</span>
<span class="token comment"># The length of the Ethernet frame header is 14 bytes:</span>
    ip_packet <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span>sk<span class="token punctuation">.</span>raw<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># The length of the IP packet header is not fixed due to the arbitrary</span>
    <span class="token comment"># number of parameters.</span>
    <span class="token comment"># Of all the possible IP header we are only interested in 20 bytes:</span>
    <span class="token punctuation">(</span>length<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> proto<span class="token punctuation">,</span> _<span class="token punctuation">,</span> saddr<span class="token punctuation">,</span> daddr<span class="token punctuation">)</span> <span class="token operator">=</span> unpack<span class="token punctuation">(</span><span class="token string">'!BBHLBBHLL'</span><span class="token punctuation">,</span> ip_packet<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment"># The direct length is written in the second half of the first byte (0b00001111 = 15):</span>
    <span class="token comment"># len_iph = length &amp; 15</span>
    <span class="token comment"># Length is written in 32-bit words, convert it to bytes:</span>
    <span class="token comment"># len_iph = len_iph * 4</span>
    <span class="token comment"># Convert addresses from numbers into IPs, assembling it into octets:</span>
    saddr <span class="token operator">=</span> <span class="token string">"."</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>saddr <span class="token operator">>></span> <span class="token number">24</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">,</span> saddr <span class="token operator">>></span> <span class="token number">16</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">,</span> saddr <span class="token operator">>></span> <span class="token number">8</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">,</span> saddr <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    daddr <span class="token operator">=</span> <span class="token string">"."</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>daddr <span class="token operator">>></span> <span class="token number">24</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">,</span> daddr <span class="token operator">>></span> <span class="token number">16</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">,</span> daddr <span class="token operator">>></span> <span class="token number">8</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">,</span> daddr <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># If the transport layer protocol is UDP:</span>
    <span class="token keyword">if</span> proto <span class="token operator">==</span> <span class="token number">17</span><span class="token punctuation">:</span>
        udp_packet <span class="token operator">=</span> ip_packet<span class="token punctuation">[</span>len_iph<span class="token punctuation">:</span><span class="token punctuation">]</span>
        <span class="token punctuation">(</span>sport<span class="token punctuation">,</span> dport<span class="token punctuation">)</span> <span class="token operator">=</span> unpack<span class="token punctuation">(</span><span class="token string">'!HH'</span><span class="token punctuation">,</span> udp_packet<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># UDP datagram header length is 8 bytes:</span>
        dns_packet <span class="token operator">=</span> udp_packet<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
    <span class="token comment"># If the transport layer protocol is TCP:</span>
    <span class="token keyword">elif</span> proto <span class="token operator">==</span> <span class="token number">6</span><span class="token punctuation">:</span>
        tcp_packet <span class="token operator">=</span> ip_packet<span class="token punctuation">[</span>len_iph<span class="token punctuation">:</span><span class="token punctuation">]</span>
        <span class="token comment"># TCP packet header length is also not fixed due to the optional</span>
        <span class="token comment"># options. Of the entire TCP header, we are only interested in the data up to the 13th</span>
        <span class="token comment"># byte (header length):</span>
        <span class="token punctuation">(</span>sport<span class="token punctuation">,</span> dport<span class="token punctuation">,</span> _<span class="token punctuation">,</span> length<span class="token punctuation">)</span> <span class="token operator">=</span> unpack<span class="token punctuation">(</span><span class="token string">'!HHQB'</span><span class="token punctuation">,</span> tcp_packet<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># The direct length is written in the first half (4 bits):</span>
        len_tcph <span class="token operator">=</span> length <span class="token operator">>></span> <span class="token number">4</span>
        <span class="token comment"># Length is written in 32-bit words, converted to bytes:</span>
        len_tcph <span class="token operator">=</span> len_tcph <span class="token operator">*</span> <span class="token number">4</span>
        <span class="token comment"># That's the tricky part.</span>
        <span class="token comment"># I don't know where I went wrong or why I need a 2 byte offset,</span>
        <span class="token comment"># but it's necessary because the DNS packet doesn't start until after it:</span>
        dns_packet <span class="token operator">=</span> tcp_packet<span class="token punctuation">[</span>len_tcph <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
    <span class="token comment"># other protocols are not handled:</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span>
<span class="token comment"># DNS data decoding:</span>
    dns_data <span class="token operator">=</span> dnslib<span class="token punctuation">.</span>DNSRecord<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>dns_packet<span class="token punctuation">)</span>
<span class="token comment"># Resource record types:</span>
    DNS_QTYPE <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">:</span> <span class="token string">"A"</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">:</span> <span class="token string">"AAAA"</span><span class="token punctuation">}</span>
<span class="token comment"># Query:</span>
    If dns_data<span class="token punctuation">.</span>header<span class="token punctuation">.</span>qr <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token comment"># We are only interested in A (1) and AAAA (28) records:</span>
        <span class="token keyword">for</span> q <span class="token keyword">in</span> dns_data<span class="token punctuation">.</span>questions<span class="token punctuation">:</span>
            If q<span class="token punctuation">.</span>qtype <span class="token operator">==</span> <span class="token number">1</span> <span class="token keyword">or</span> q<span class="token punctuation">.</span>qtype <span class="token operator">==</span> <span class="token number">28</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'COMM=</span><span class="token interpolation"><span class="token punctuation">{</span>proc_name<span class="token punctuation">}</span></span><span class="token string"> PID=</span><span class="token interpolation"><span class="token punctuation">{</span>sk<span class="token punctuation">.</span>pid<span class="token punctuation">}</span></span><span class="token string"> TGID=</span><span class="token interpolation"><span class="token punctuation">{</span>sk<span class="token punctuation">.</span>tgid<span class="token punctuation">}</span></span><span class="token string"> DEV=</span><span class="token interpolation"><span class="token punctuation">{</span>ifname<span class="token punctuation">}</span></span><span class="token string"> PROTO=</span><span class="token interpolation"><span class="token punctuation">{</span>NET_PROTO<span class="token punctuation">[</span>proto<span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> SRC=</span><span class="token interpolation"><span class="token punctuation">{</span>saddr<span class="token punctuation">}</span></span><span class="token string"> DST=</span><span class="token interpolation"><span class="token punctuation">{</span>daddr<span class="token punctuation">}</span></span><span class="token string"> SPT=</span><span class="token interpolation"><span class="token punctuation">{</span>sport<span class="token punctuation">}</span></span><span class="token string"> DPT=</span><span class="token interpolation"><span class="token punctuation">{</span>dport<span class="token punctuation">}</span></span><span class="token string"> UID=</span><span class="token interpolation"><span class="token punctuation">{</span>sk<span class="token punctuation">.</span>uid<span class="token punctuation">}</span></span><span class="token string"> GID=</span><span class="token interpolation"><span class="token punctuation">{</span>sk<span class="token punctuation">.</span>gid<span class="token punctuation">}</span></span><span class="token string"> DNS_QR=0 DNS_NAME=</span><span class="token interpolation"><span class="token punctuation">{</span>q<span class="token punctuation">.</span>qname<span class="token punctuation">}</span></span><span class="token string"> DNS_TYPE=</span><span class="token interpolation"><span class="token punctuation">{</span>DNS_QTYPE<span class="token punctuation">[</span>q<span class="token punctuation">.</span>qtype<span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    <span class="token comment"># Response:</span>
    <span class="token keyword">elif</span> dns_data<span class="token punctuation">.</span>header<span class="token punctuation">.</span>qr <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token comment"># We are only interested in A (1) and AAAA (28) records:</span>
        For rr <span class="token keyword">in</span> dns_data<span class="token punctuation">.</span>rr<span class="token punctuation">:</span>
            If rr<span class="token punctuation">.</span>rtype <span class="token operator">==</span> <span class="token number">1</span> <span class="token keyword">or</span> rr<span class="token punctuation">.</span>rtype <span class="token operator">==</span> <span class="token number">28</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'COMM=</span><span class="token interpolation"><span class="token punctuation">{</span>proc_name<span class="token punctuation">}</span></span><span class="token string"> PID=</span><span class="token interpolation"><span class="token punctuation">{</span>sk<span class="token punctuation">.</span>pid<span class="token punctuation">}</span></span><span class="token string"> TGID=</span><span class="token interpolation"><span class="token punctuation">{</span>sk<span class="token punctuation">.</span>tgid<span class="token punctuation">}</span></span><span class="token string"> DEV=</span><span class="token interpolation"><span class="token punctuation">{</span>ifname<span class="token punctuation">}</span></span><span class="token string"> PROTO=</span><span class="token interpolation"><span class="token punctuation">{</span>NET_PROTO<span class="token punctuation">[</span>proto<span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> SRC=</span><span class="token interpolation"><span class="token punctuation">{</span>saddr<span class="token punctuation">}</span></span><span class="token string"> DST=</span><span class="token interpolation"><span class="token punctuation">{</span>daddr<span class="token punctuation">}</span></span><span class="token string"> SPT=</span><span class="token interpolation"><span class="token punctuation">{</span>sport<span class="token punctuation">}</span></span><span class="token string"> DPT=</span><span class="token interpolation"><span class="token punctuation">{</span>dport<span class="token punctuation">}</span></span><span class="token string"> UID=</span><span class="token interpolation"><span class="token punctuation">{</span>sk<span class="token punctuation">.</span>uid<span class="token punctuation">}</span></span><span class="token string"> GID=</span><span class="token interpolation"><span class="token punctuation">{</span>sk<span class="token punctuation">.</span>gid<span class="token punctuation">}</span></span><span class="token string"> DNS_QR=1 DNS_NAME=</span><span class="token interpolation"><span class="token punctuation">{</span>rr<span class="token punctuation">.</span>rname<span class="token punctuation">}</span></span><span class="token string"> DNS_TYPE=</span><span class="token interpolation"><span class="token punctuation">{</span>DNS_QTYPE<span class="token punctuation">[</span>rr<span class="token punctuation">.</span>rtype<span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> DNS_DATA=</span><span class="token interpolation"><span class="token punctuation">{</span>rr<span class="token punctuation">.</span>rdata<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Invalid DNS query type.'</span><span class="token punctuation">)</span></code></pre></div>
<h2>At The End</h2>
<p>Launch the app .py and make a request with dig tools in the next console:</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># dig @1.1.1.1 google.com +tcp</span></code></pre></div>
<p>If that works, the output of the program should look like this:</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># python3 final_code_eBPF_dns.py</span>
The program is running. Press Ctrl-C to abort.
<span class="token assign-left variable">COMM</span><span class="token operator">=</span>dig <span class="token assign-left variable">PID</span><span class="token operator">=</span><span class="token number">10738</span> <span class="token assign-left variable">TGID</span><span class="token operator">=</span><span class="token number">10739</span> <span class="token assign-left variable">DEV</span><span class="token operator">=</span>ens18 <span class="token assign-left variable">PROTO</span><span class="token operator">=</span>TCP <span class="token assign-left variable">SRC</span><span class="token operator">=</span><span class="token number">192.168</span>.44.3 <span class="token assign-left variable">DST</span><span class="token operator">=</span><span class="token number">1.1</span>.1.1 <span class="token assign-left variable">SPT</span><span class="token operator">=</span><span class="token number">57915</span> <span class="token assign-left variable">DPT</span><span class="token operator">=</span><span class="token number">53</span> <span class="token assign-left variable"><span class="token environment constant">UID</span></span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">GID</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">DNS_QR</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">DNS_NAME</span><span class="token operator">=</span>google.com. <span class="token assign-left variable">DNS_TYPE</span><span class="token operator">=</span>A
<span class="token assign-left variable">COMM</span><span class="token operator">=</span>dig <span class="token assign-left variable">PID</span><span class="token operator">=</span><span class="token number">10738</span> <span class="token assign-left variable">TGID</span><span class="token operator">=</span><span class="token number">10739</span> <span class="token assign-left variable">DEV</span><span class="token operator">=</span>ens18 <span class="token assign-left variable">PROTO</span><span class="token operator">=</span>TCP <span class="token assign-left variable">SRC</span><span class="token operator">=</span><span class="token number">1.1</span>.1.1 <span class="token assign-left variable">DST</span><span class="token operator">=</span><span class="token number">192.168</span>.44.3 <span class="token assign-left variable">SPT</span><span class="token operator">=</span><span class="token number">53</span> <span class="token assign-left variable">DPT</span><span class="token operator">=</span><span class="token number">57915</span> <span class="token assign-left variable"><span class="token environment constant">UID</span></span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">GID</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">DNS_QR</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">DNS_NAME</span><span class="token operator">=</span>google.com. <span class="token assign-left variable">DNS_TYPE</span><span class="token operator">=</span>A <span class="token assign-left variable">DNS_DATA</span><span class="token operator">=</span><span class="token number">142.251</span>.12.101
<span class="token assign-left variable">COMM</span><span class="token operator">=</span>dig <span class="token assign-left variable">PID</span><span class="token operator">=</span><span class="token number">10738</span> <span class="token assign-left variable">TGID</span><span class="token operator">=</span><span class="token number">10739</span> <span class="token assign-left variable">DEV</span><span class="token operator">=</span>ens18 <span class="token assign-left variable">PROTO</span><span class="token operator">=</span>TCP <span class="token assign-left variable">SRC</span><span class="token operator">=</span><span class="token number">1.1</span>.1.1 <span class="token assign-left variable">DST</span><span class="token operator">=</span><span class="token number">192.168</span>.44.3 <span class="token assign-left variable">SPT</span><span class="token operator">=</span><span class="token number">53</span> <span class="token assign-left variable">DPT</span><span class="token operator">=</span><span class="token number">57915</span> <span class="token assign-left variable"><span class="token environment constant">UID</span></span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">GID</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">DNS_QR</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">DNS_NAME</span><span class="token operator">=</span>google.com. <span class="token assign-left variable">DNS_TYPE</span><span class="token operator">=</span>A <span class="token assign-left variable">DNS_DATA</span><span class="token operator">=</span><span class="token number">142.251</span>.12.113
<span class="token assign-left variable">COMM</span><span class="token operator">=</span>dig <span class="token assign-left variable">PID</span><span class="token operator">=</span><span class="token number">10738</span> <span class="token assign-left variable">TGID</span><span class="token operator">=</span><span class="token number">10739</span> <span class="token assign-left variable">DEV</span><span class="token operator">=</span>ens18 <span class="token assign-left variable">PROTO</span><span class="token operator">=</span>TCP <span class="token assign-left variable">SRC</span><span class="token operator">=</span><span class="token number">1.1</span>.1.1 <span class="token assign-left variable">DST</span><span class="token operator">=</span><span class="token number">192.168</span>.44.3 <span class="token assign-left variable">SPT</span><span class="token operator">=</span><span class="token number">53</span> <span class="token assign-left variable">DPT</span><span class="token operator">=</span><span class="token number">57915</span> <span class="token assign-left variable"><span class="token environment constant">UID</span></span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">GID</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">DNS_QR</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">DNS_NAME</span><span class="token operator">=</span>google.com. <span class="token assign-left variable">DNS_TYPE</span><span class="token operator">=</span>A <span class="token assign-left variable">DNS_DATA</span><span class="token operator">=</span><span class="token number">142.251</span>.12.102
<span class="token assign-left variable">COMM</span><span class="token operator">=</span>dig <span class="token assign-left variable">PID</span><span class="token operator">=</span><span class="token number">10738</span> <span class="token assign-left variable">TGID</span><span class="token operator">=</span><span class="token number">10739</span> <span class="token assign-left variable">DEV</span><span class="token operator">=</span>ens18 <span class="token assign-left variable">PROTO</span><span class="token operator">=</span>TCP <span class="token assign-left variable">SRC</span><span class="token operator">=</span><span class="token number">1.1</span>.1.1 <span class="token assign-left variable">DST</span><span class="token operator">=</span><span class="token number">192.168</span>.44.3 <span class="token assign-left variable">SPT</span><span class="token operator">=</span><span class="token number">53</span> <span class="token assign-left variable">DPT</span><span class="token operator">=</span><span class="token number">57915</span> <span class="token assign-left variable"><span class="token environment constant">UID</span></span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">GID</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">DNS_QR</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">DNS_NAME</span><span class="token operator">=</span>google.com. <span class="token assign-left variable">DNS_TYPE</span><span class="token operator">=</span>A <span class="token assign-left variable">DNS_DATA</span><span class="token operator">=</span><span class="token number">142.251</span>.12.139
<span class="token assign-left variable">COMM</span><span class="token operator">=</span>dig <span class="token assign-left variable">PID</span><span class="token operator">=</span><span class="token number">10738</span> <span class="token assign-left variable">TGID</span><span class="token operator">=</span><span class="token number">10739</span> <span class="token assign-left variable">DEV</span><span class="token operator">=</span>ens18 <span class="token assign-left variable">PROTO</span><span class="token operator">=</span>TCP <span class="token assign-left variable">SRC</span><span class="token operator">=</span><span class="token number">1.1</span>.1.1 <span class="token assign-left variable">DST</span><span class="token operator">=</span><span class="token number">192.168</span>.44.3 <span class="token assign-left variable">SPT</span><span class="token operator">=</span><span class="token number">53</span> <span class="token assign-left variable">DPT</span><span class="token operator">=</span><span class="token number">57915</span> <span class="token assign-left variable"><span class="token environment constant">UID</span></span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">GID</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">DNS_QR</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">DNS_NAME</span><span class="token operator">=</span>google.com. <span class="token assign-left variable">DNS_TYPE</span><span class="token operator">=</span>A <span class="token assign-left variable">DNS_DATA</span><span class="token operator">=</span><span class="token number">142.251</span>.12.100
<span class="token assign-left variable">COMM</span><span class="token operator">=</span>dig <span class="token assign-left variable">PID</span><span class="token operator">=</span><span class="token number">10738</span> <span class="token assign-left variable">TGID</span><span class="token operator">=</span><span class="token number">10739</span> <span class="token assign-left variable">DEV</span><span class="token operator">=</span>ens18 <span class="token assign-left variable">PROTO</span><span class="token operator">=</span>TCP <span class="token assign-left variable">SRC</span><span class="token operator">=</span><span class="token number">1.1</span>.1.1 <span class="token assign-left variable">DST</span><span class="token operator">=</span><span class="token number">192.168</span>.44.3 <span class="token assign-left variable">SPT</span><span class="token operator">=</span><span class="token number">53</span> <span class="token assign-left variable">DPT</span><span class="token operator">=</span><span class="token number">57915</span> <span class="token assign-left variable"><span class="token environment constant">UID</span></span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">GID</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">DNS_QR</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">DNS_NAME</span><span class="token operator">=</span>google.com. <span class="token assign-left variable">DNS_TYPE</span><span class="token operator">=</span>A <span class="token assign-left variable">DNS_DATA</span><span class="token operator">=</span><span class="token number">142.251</span>.12.138</code></pre></div>
<p>So we have created a useful application that shows all DNS queries in our system. I hope my explanations were quite detailed, and if you are interested in writing eBPF programs, it will be easier for you to start. This code has already helped me better understand what is happening on the servers. Below I post its full code.</p>
<h2>Conclusion</h2>
<p>Can it be done even better? Of course! First, you should add IPv6 support. Secondly, finally stop relying on the fixed length of the IP header and usually parse it. It’s not for nothing that I refused to use the library in Python to work with packages — in C, and you still have to do it manually. Thirdly, it would be good to rewrite the code in C, abandoning Python completely and of course adding lines of code for JSON output, making it easier for later in developing the UI dashboard. This will lead to the fourth point-manual analysis of the DNS packet. And finally, the most tempting point is to stop looking at ports (Because maybe DNS packets don’t always cross the port 53) and try to analyze each packet and search among them for those that fit the DNS format. This will allow us to detect packets even on non-standard ports.</p>
<p><a href="https://gist.github.com/oghie/b4e3accf1f87afcb939f884723e2b462">Here’s the final code.</a></p></div></article></div><footer class="site-footer"><p>© <!-- -->2022<!-- --> Coconut Lab • Crafted with<!-- --> <span role="img" aria-label="love">❤️</span>  by <a href="https://github.com/kelapa148">kelapa148</a></p></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/blog/A-Deep-Dive-into-eBPF-Writing-an-Efficient-DNS-Monitoring";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-f6cc04c3d52b80790811.js"],"app":["/app-673a4e1fe8d7056214a0.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-b0556ce5127c1a3e2490.js"],"component---src-pages-404-js":["/component---src-pages-404-js-0f0a4ac6f0d505a82440.js"],"component---src-pages-blog-js":["/component---src-pages-blog-js-70a95eb3cdd0930f20d0.js"],"component---src-pages-contact-js":["/component---src-pages-contact-js-7861b28293b4f5220755.js"],"component---src-pages-index-js":["/component---src-pages-index-js-ed0d90343a793c513dbb.js"],"component---src-pages-people-js":["/component---src-pages-people-js-630f248bd937842d2347.js"],"component---src-pages-publications-js":["/component---src-pages-publications-js-c1343aec0e59c5eb0b58.js"],"component---src-pages-resources-js":["/component---src-pages-resources-js-922c31b3eef41392a4f9.js"],"component---src-templates-blog-template-js":["/component---src-templates-blog-template-js-ae206132cc4c9aa40802.js"],"component---src-templates-people-template-js":["/component---src-templates-people-template-js-3085ca685b4116071690.js"],"component---src-templates-resource-template-js":["/component---src-templates-resource-template-js-63277d52a75b47c02d9c.js"]};/*]]>*/</script><script src="/polyfill-f6cc04c3d52b80790811.js" nomodule=""></script><script src="/component---src-templates-blog-template-js-ae206132cc4c9aa40802.js" async=""></script><script src="/6b858033f0c41a2341f97b0990d9e7b8428feed3-09e633e911b47e485fbe.js" async=""></script><script src="/app-673a4e1fe8d7056214a0.js" async=""></script><script src="/532a2f07-cee85b289ce281e20d67.js" async=""></script><script src="/styles-84a9bc99193fe5828ffe.js" async=""></script><script src="/framework-31413af41550353e296a.js" async=""></script><script src="/webpack-runtime-d26e86d850dfdeba7fbd.js" async=""></script></body></html>